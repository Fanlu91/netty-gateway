使用压测工具（wrk 或 sb），演练 gateway-server-0.0.1-SNAPSHOT.jar 示例。

### wrk安装和使用

```shell
brew install wrk

使用方法: wrk <选项> <被测HTTP服务的URL>                            
  Options:                                            
    -c, --connections <N>  跟服务器建立并保持的TCP连接数量  
    -d, --duration    <T>  压测时间           
    -t, --threads     <N>  使用多少个线程进行压测   
                                                      
    -s, --script      <S>  指定Lua脚本路径       
    -H, --header      <H>  为每一个HTTP请求添加HTTP头      
        --latency          在压测结束后，打印延迟统计信息   
        --timeout     <T>  超时时间     
    -v, --version          打印正在使用的wrk的详细版本信息
                                                      
  <N>代表数字参数，支持国际单位 (1k, 1M, 1G)
  <T>代表时间参数，支持时间单位 (2s, 2m, 2h)
```



### 启动gateway server

```shell
➜  week01 git:(master) ✗ java -jar gateway-server-0.0.1-SNAPSHOT.jar
➜  week01 git:(master) ✗ jps -l
2225
33619 sun.tools.jps.Jps
33896 gateway-server-0.0.1-SNAPSHOT.jar
2740 org.jetbrains.jps.cmdline.Launcher


➜  week01 git:(master) ✗ jcmd 33896 GC.heap_info
33896:
 PSYoungGen      total 275968K, used 27667K [0x000000076ab00000, 0x000000077d380000, 0x00000007c0000000)
  eden space 265728K, 10% used [0x000000076ab00000,0x000000076c604f08,0x000000077ae80000)
  from space 10240K, 0% used [0x000000077c980000,0x000000077c980000,0x000000077d380000)
  to   space 14848K, 0% used [0x000000077b680000,0x000000077b680000,0x000000077c500000)
 ParOldGen       total 161792K, used 16403K [0x00000006c0000000, 0x00000006c9e00000, 0x000000076ab00000)
  object space 161792K, 10% used [0x00000006c0000000,0x00000006c1004ca8,0x00000006c9e00000)
 Metaspace       used 34667K, capacity 36138K, committed 36312K, reserved 1081344K
  class space    used 4351K, capacity 4645K, committed 4736K, reserved 1048576K
  
# 使用1g的空间  
➜  week01 git:(master) ✗ java -Xms1g -Xmx1g -jar gateway-server-0.0.1-SNAPSHOT.jar
➜  week01 git:(master) ✗ jps -l
2225
34275 sun.tools.jps.Jps
2740 org.jetbrains.jps.cmdline.Launcher
34263 gateway-server-0.0.1-SNAPSHOT.jar
➜  week01 git:(master) ✗ jcmd 34263 GC.heap_info
34263:
 PSYoungGen      total 305664K, used 237026K [0x00000007aab00000, 0x00000007c0000000, 0x00000007c0000000)
  eden space 262144K, 84% used [0x00000007aab00000,0x00000007b833d1c0,0x00000007bab00000)
  from space 43520K, 35% used [0x00000007bd580000,0x00000007be4bb670,0x00000007c0000000)
  to   space 43520K, 0% used [0x00000007bab00000,0x00000007bab00000,0x00000007bd580000)
 ParOldGen       total 699392K, used 13672K [0x0000000780000000, 0x00000007aab00000, 0x00000007aab00000)
  object space 699392K, 1% used [0x0000000780000000,0x0000000780d5a1d8,0x00000007aab00000)
 Metaspace       used 33378K, capacity 34826K, committed 35072K, reserved 1079296K
  class space    used 4191K, capacity 4495K, committed 4608K, reserved 1048576K
  
➜  week01 git:(master) ✗ jstat -gc -t 34263 1000
Timestamp        S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT
          111.6 43520.0 43520.0 15597.6  0.0   262144.0 221432.5  699392.0   13672.5   31744.0 30244.6 4096.0 3784.2      2    0.022   1      0.024    0.046
```



### 基准测试

#### 配置

1G heap

```shell
➜  ~ wrk -t 5 -c 50 -d 10s http://localhost:8088/api/hello
Running 10s test @ http://localhost:8088/api/hello
  5 threads and 50 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     9.97ms   23.86ms 214.47ms   90.68%
    Req/Sec     4.43k     1.94k    9.87k    64.44%
  218747 requests in 10.03s, 26.12MB read
Requests/sec:  21799.89
Transfer/sec:      2.60MB

➜  ~ wrk -t 10 -c 100 -d 10s http://localhost:8088/api/hello
Running 10s test @ http://localhost:8088/api/hello
  10 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.01ms    1.60ms  40.07ms   93.39%
    Req/Sec     5.10k     0.87k    9.55k    72.70%
  509575 requests in 10.05s, 60.84MB read
Requests/sec:  50707.34
Transfer/sec:      6.05MB
```



#### gc 状态

```less
week01 git:(master) ✗ jstat -gcutil -t 34263 1000
Timestamp         S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT
          346.7   1.92   0.00  10.46   3.26  94.34  90.99     24    0.081     2    0.062    0.143
          347.7   1.92   0.00  56.88   3.26  94.34  90.99     24    0.081     2    0.062    0.143
          348.8  17.43   0.00   6.32   3.28  94.35  91.00     28    0.090     2    0.062    0.152
          349.7   0.00  22.92  30.10   3.28  94.35  91.00     31    0.096     2    0.062    0.159
          350.8  27.60   0.00  93.53   3.28  94.39  91.08     34    0.102     2    0.062    0.164
          351.7  33.75   0.00  76.64   3.29  94.39  91.09     38    0.109     2    0.062    0.172
          352.7   0.00   7.81  39.64   3.48  94.39  91.09     43    0.119     2    0.062    0.181
          353.7   8.93   0.00   0.00   3.52  94.39  91.09     48    0.127     2    0.062    0.190
          354.8   9.38   0.00   7.20   3.52  94.39  91.09     52    0.135     2    0.062    0.197
          355.8  11.25   0.00   0.00   3.53  94.40  91.09     56    0.142     2    0.062    0.204
          356.7   0.00  17.19  55.92   3.54  94.40  91.09     59    0.148     2    0.062    0.210
          357.8  17.19   0.00  84.19   3.55  94.40  91.11     62    0.153     2    0.062    0.216
          358.8  17.19   0.00  84.19   3.55  94.40  91.11     62    0.153     2    0.062    0.216
```

分配速率很高，不过提升速率并不高，没有触发full gc。





### 压测 1

#### 尝试提高压力线程数和连接数。

```shell
➜  ~ wrk -t 50 -c 500 -d 10s http://localhost:8088/api/hello
unable to create thread 26: Too many open files


➜  ~ ulimit -a
-t: cpu time (seconds)              unlimited
-f: file size (blocks)              unlimited
-d: data seg size (kbytes)          unlimited
-s: stack size (kbytes)             8192
-c: core file size (blocks)         0
-v: address space (kbytes)          unlimited
-l: locked-in-memory size (kbytes)  unlimited
-u: processes                       2784
-n: file descriptors                256

➜  ~ sysctl kern.maxfiles
kern.maxfiles: 49152
➜  ~ sysctl kern.maxfilesperproc
kern.maxfilesperproc: 24576


➜  ~ wrk -t 25 -c 255 -d 10s http://localhost:8088/api/hello
Running 10s test @ http://localhost:8088/api/hello
  25 threads and 255 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.02ms    1.57ms  18.70ms   76.67%
    Req/Sec     2.22k   652.73     4.45k    87.96%
  556271 requests in 10.10s, 66.41MB read
  Socket errors: connect 24, read 112, write 0, timeout 0
Requests/sec:  55083.78
Transfer/sec:      6.58MB

```



```less
➜  week01 git:(master) ✗ jstat -gcutil -t 34263 500
Timestamp         S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT
          790.7  17.19   0.00  84.54   3.55  94.40  91.11     62    0.153     2    0.062    0.216
          791.3  17.19   0.00  84.54   3.55  94.40  91.11     62    0.153     2    0.062    0.216
          791.8  17.19   0.00  84.54   3.55  94.40  91.11     62    0.153     2    0.062    0.216
          792.2  17.19   0.00  84.54   3.55  94.40  91.11     62    0.153     2    0.062    0.216
          792.8  17.19   0.00  84.54   3.55  94.40  91.11     62    0.153     2    0.062    0.216
          793.3 100.00   0.00  73.89   3.76  94.46  91.11     64    0.157     2    0.062    0.220
          793.8  80.21   0.00  95.61   3.76  94.46  91.11     66    0.162     2    0.062    0.224
          794.3   0.00  98.75   1.69   3.76  94.46  91.11     69    0.168     2    0.062    0.231
          794.8   0.00  56.25  30.44   3.76  94.46  91.11     71    0.172     2    0.062    0.235
          795.3   0.00  54.17  56.09   3.76  94.46  91.11     73    0.177     2    0.062    0.239
          795.8   0.00  56.25  77.01   3.76  94.46  91.11     75    0.181     2    0.062    0.243
          796.3   0.00  56.25  91.23   3.76  94.46  91.11     77    0.185     2    0.062    0.247
          796.8   9.03   0.00   0.00   4.05  94.46  91.11     80    0.192     2    0.062    0.255
          797.3  11.11   0.00  27.45   4.06  94.46  91.11     82    0.196     2    0.062    0.259
          797.8  11.72   0.00  62.52   4.06  94.46  91.11     84    0.200     2    0.062    0.262
          798.3  12.50   0.00  75.75   4.06  94.46  91.11     86    0.204     2    0.062    0.266
          798.8   0.00  12.50   6.22   4.07  94.46  91.11     89    0.210     2    0.062    0.272
          799.3   0.00  13.39  25.49   4.08  94.46  91.11     91    0.214     2    0.062    0.276
          799.8   0.00  14.58   1.13   4.08  94.46  91.11     93    0.218     2    0.062    0.281
          800.3   0.00  14.58   0.00   4.08  94.50  91.11     95    0.222     2    0.062    0.285
          800.8  17.50   0.00  85.10   4.08  94.50  91.11     96    0.224     2    0.062    0.287
          801.3  18.75   0.00  82.59   4.08  94.50  91.11     98    0.229     2    0.062    0.291
          801.8  20.31   0.00  58.34   4.10  94.50  91.11    100    0.233     2    0.062    0.295
          802.3  21.88   0.00  40.79   4.10  94.50  91.11    102    0.237     2    0.062    0.299
```



#### 进一步提高连接数

```shell
➜  ~ ulimit -S -n 10240
➜  ~ ulimit -a
-t: cpu time (seconds)              unlimited
-f: file size (blocks)              unlimited
-d: data seg size (kbytes)          unlimited
-s: stack size (kbytes)             8192
-c: core file size (blocks)         0
-v: address space (kbytes)          unlimited
-l: locked-in-memory size (kbytes)  unlimited
-u: processes                       2784
-n: file descriptors                10240

➜  ~ wrk -t 100 -c 10000 -d 10s http://localhost:8088/api/hello
Running 10s test @ http://localhost:8088/api/hello
  100 threads and 10000 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    55.02ms   61.59ms   1.87s    99.16%
    Req/Sec   219.39    304.42     2.62k    92.86%
  23581 requests in 10.11s, 2.81MB read
  Socket errors: connect 0, read 10422, write 0, timeout 35
Requests/sec:   2333.46
Transfer/sec:    284.85KB
```

线程数过大性能反而降低



```less
➜  ~ wrk -t 10 -c 1000 -d 10s http://localhost:8088/api/hello
Running 10s test @ http://localhost:8088/api/hello
  10 threads and 1000 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    19.64ms   15.94ms 195.04ms   95.15%
    Req/Sec     5.17k     1.36k   17.18k    83.20%
  512638 requests in 10.10s, 61.20MB read
  Socket errors: connect 0, read 4316, write 0, timeout 0
Requests/sec:  50764.31
Transfer/sec:      6.06MB


```



### 压测2

#### 降低堆内存大小

```shell
➜  week01 git:(master) ✗ java -Xms128m -Xmx128m -jar gateway-server-0.0.1-SNAPSHOT.jar

➜  ~ wrk -t 12 -c 120 -d 100s http://localhost:8088/api/hello
Running 2m test @ http://localhost:8088/api/hello
  12 threads and 120 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    19.90ms   71.41ms 943.58ms   93.22%
    Req/Sec     3.68k     0.97k   12.99k    84.98%
  4129990 requests in 1.67m, 493.08MB read
  Socket errors: connect 0, read 9, write 0, timeout 0
Requests/sec:  41262.04
Transfer/sec:      4.93MB

➜  week01 git:(master) ✗ jstat -gcutil -t 35283 500
Timestamp         S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT
          260.1  50.00   0.00  69.83  77.40  93.54  89.32   2814    5.106     4    0.228    5.334
          260.6  50.00   0.00  69.83  77.40  93.54  89.32   2814    5.106     4    0.228    5.334
          261.1  50.00   0.00  69.83  77.40  93.54  89.32   2814    5.106     4    0.228    5.334
          261.6  50.00   0.00  69.83  77.40  93.54  89.32   2814    5.106     4    0.228    5.334
          262.1   0.00  62.50  20.00  78.12  93.58  89.32   2817    5.111     4    0.228    5.339
          262.6   0.00  50.00   0.00  79.22  93.58  89.32   2833    5.136     4    0.228    5.364
          263.1  50.00   0.00   0.00  80.06  93.59  89.32   2848    5.162     4    0.228    5.390
          263.6   0.00  50.00   0.00  80.98  93.59  89.32   2863    5.186     4    0.228    5.415
          264.1   0.00  50.00   0.00  82.06  93.59  89.32   2879    5.214     4    0.228    5.442
          264.6  50.00   0.00   0.00  83.00  93.59  89.32   2894    5.238     4    0.228    5.466
          265.1   0.00  50.00   0.00  84.11  93.59  89.32   2911    5.266     4    0.228    5.494
          265.6   0.00  50.00   0.00  85.14  93.59  89.32   2927    5.291     4    0.228    5.519
          266.1  50.00   0.00   0.00  86.19  93.59  89.32   2944    5.318     4    0.228    5.546
          266.6  43.75   0.00  24.25  87.22  93.59  89.32   2960    5.344     4    0.228    5.573
          267.1  50.00   0.00  79.99  88.14  93.59  89.32   2974    5.369     4    0.228    5.597
          267.6   0.00  50.00   0.00  89.07  93.59  89.32   2990    5.395     4    0.228    5.623
          268.1  50.00   0.00   0.00  90.02  93.59  89.32   3004    5.422     4    0.228    5.650
          268.6   0.00  50.00   0.00  90.97  93.59  89.32   3019    5.447     4    0.228    5.675
          269.1   0.00  50.00   0.00  91.86  93.59  89.32   3033    5.470     4    0.228    5.699
          269.6   0.00  50.00   0.00  92.77  93.59  89.32   3047    5.494     4    0.228    5.722
          270.1   0.00  50.00   0.00  93.69  93.59  89.32   3061    5.518     4    0.228    5.746
          270.6   0.00  50.00  68.37  94.60  93.59  89.32   3076    5.541     4    0.228    5.769
          271.1  50.00   0.00   0.00  95.53  93.59  89.32   3090    5.567     4    0.228    5.795
          271.6  50.00   0.00   0.00  96.44  93.59  89.32   3104    5.589     4    0.228    5.818
          272.1   0.00  50.00   0.00  97.41  93.59  89.32   3119    5.614     4    0.228    5.843
          272.7   0.00  50.00  35.55  98.35  93.59  89.32   3133    5.638     4    0.228    5.866
          273.1   0.00  50.00   0.00  99.30  93.59  89.32   3147    5.662     4    0.228    5.890
          273.6   0.00  50.00   0.00  32.36  93.59  89.32   3161    5.685     5    0.257    5.942
          274.1  50.00   0.00   0.00  33.39  93.59  89.32   3176    5.710     5    0.257    5.967
          274.7  50.00   0.00  84.84  34.24  93.59  89.32   3191    5.732     5    0.257    5.989
          275.1   0.00  50.00   0.00  35.18  93.59  89.32   3205    5.757     5    0.257    6.014
          275.6  50.00   0.00  98.93  36.09  93.59  89.32   3218    5.778     5    0.257    6.035
          276.2  50.00   0.00  43.43  36.86  93.59  89.32   3230    5.798     5    0.257    6.055
          276.7  50.00   0.00   1.95  37.93  93.59  89.32   3246    5.824     5    0.257    6.081
          277.1   0.00  50.00   0.00  38.88  93.59  89.32   3261    5.848     5    0.257    6.105
          277.7  50.00   0.00  43.52  39.81  93.59  89.32   3276    5.873     5    0.257    6.130
          278.2  50.00   0.00   0.00  40.85  93.59  89.32   3292    5.899     5    0.257    6.156
          278.6  50.00   0.00   0.00  41.72  93.59  89.32   3306    5.923     5    0.257    6.180
          279.2  50.00   0.00  13.32  42.64  93.59  89.32   3321    5.947     5    0.257    6.203
          279.7   0.00  50.00   0.00  43.62  93.59  89.32   3335    5.972     5    0.257    6.229
          280.1   0.00  50.00   0.00  44.52  93.59  89.32   3349    5.995     5    0.257    6.252
          280.7  50.00   0.00   0.00  45.48  93.59  89.32   3364    6.020     5    0.257    6.277
          281.2   0.00  50.00  48.82  46.27  93.59  89.32   3377    6.044     5    0.257    6.301
          281.6  50.00   0.00   0.00  47.10  93.59  89.32   3390    6.066     5    0.257    6.323
          282.2   0.00  50.00   0.00  48.10  93.59  89.32   3405    6.091     5    0.257    6.348
          282.7  50.00   0.00   0.00  49.05  93.59  89.32   3420    6.116     5    0.257    6.373
          283.2   0.00  50.00  26.26  50.05  93.59  89.32   3435    6.140     5    0.257    6.397
          283.7  50.00   0.00  73.46  51.03  93.59  89.32   3450    6.165     5    0.257    6.422
          284.2   0.00  50.00   0.00  52.00  93.59  89.32   3465    6.190     5    0.257    6.446
          284.7   0.00  50.00   0.00  52.88  93.59  89.32   3479    6.213     5    0.257    6.469
          285.2  50.00   0.00   0.00  53.85  93.59  89.32   3494    6.237     5    0.257    6.494
          285.7  50.00   0.00  35.84  54.77  93.59  89.32   3508    6.261     5    0.257    6.518
          286.2   0.00  50.00   0.00  55.71  93.59  89.32   3521    6.283     5    0.257    6.540
          286.7   0.00  50.00   0.00  56.60  93.59  89.32   3535    6.308     5    0.257    6.564
          287.2  50.00   0.00   0.00  57.64  93.59  89.32   3550    6.332     5    0.257    6.589
          287.7   0.00  50.00   0.00  58.64  93.59  89.32   3565    6.357     5    0.257    6.614
          288.2   0.00  50.00  14.45  59.57  93.59  89.32   3579    6.382     5    0.257    6.639
          288.7  50.00   0.00   0.00  60.30  93.59  89.32   3592    6.406     5    0.257    6.662
          289.2   0.00  50.00   0.00  61.27  93.59  89.32   3607    6.431     5    0.257    6.688

```

young gc 频率明显提高。应用吞吐量有所减小。

因为晋升速率不高，比较难以比较不同gc策略的差异。